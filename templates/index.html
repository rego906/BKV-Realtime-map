<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>BKV realtime</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { height:100%; }

#controls {
  position:absolute;
  top:10px;
  left:10px;
  z-index:1000;
  background:rgba(255,255,255,0.95);
  padding:10px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.2);
  font-family:Arial;
}
select, button { width:220px; margin:4px 0; }
.small { font-size:12px; color:#666; }
</style>
</head>

<body>

<div id="controls">
  <b>Sz≈±r≈ëk</b><br>

  <select id="routeFilter"></select>
  <select id="typeFilter"></select>
  <select id="plateFilter"></select>

  <button id="refreshBtn">Friss√≠t√©s</button><br>

  <label class="small">
    <input type="checkbox" id="autoRefresh">
    Automatikus friss√≠t√©s (5 mp)
  </label><br>

  <label class="small">
    <input type="checkbox" id="decorFilter">
    üéÑ Csak feld√≠sz√≠tett j√°rm≈±vek
  </label>

  <div class="small" id="status"></div>
</div>

<div id="map"></div>

<script>
/* ================= MAP ================= */
const map = L.map("map").setView([47.4979,19.0402],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ================= CLUSTER ================= */
const cluster = L.markerClusterGroup({
  disableClusteringAtZoom: 16,
  maxClusterRadius: 40
});
map.addLayer(cluster);

/* ================= IKONOK ================= */
const ICONS = {
  bus: "/icons/busz.png.png",
  tram: "/icons/villamos.png.png",
  trolley: "/icons/trolibusz.png.png",
  hev: "/icons/h√©v.png.png"
};

const DECORATED = [
  "V1347","V1608","V1441","V2038","V3873",
  "V3888","V4012","V4120","V4064","JARMU1",
  "BPI829","T9100"
];

const iconCache = {};
const markerMap = new Map();

/* ================= HELPERS ================= */
function detectMode(v){
  const m=(v.vehicle_model||"").toLowerCase();
  const r=(v.route_id||"").toLowerCase();
  if(r.startsWith("h")) return "hev";
  if(m.includes("trol")) return "trolley";
  if(m.includes("caf")||m.includes("combino")||m.includes("tatra")||m.includes("tw 6000")) return "tram";
  return "bus";
}

function iconFor(v){
  const mode=detectMode(v);
  if(!iconCache[mode]){
    iconCache[mode]=L.icon({
      iconUrl: ICONS[mode],
      iconSize:[28,28],
      iconAnchor:[14,14]
    });
  }
  return iconCache[mode];
}

function unique(arr){
  return [...new Set(arr.filter(v=>v && v!=="N/A"))].sort();
}

function fillSelect(sel,arr){
  const prev=sel.value;
  sel.innerHTML="<option value=''>√ñsszes</option>";
  arr.forEach(v=>sel.innerHTML+=`<option>${v}</option>`);
  if([...sel.options].some(o=>o.value===prev)) sel.value=prev;
}

/* ================= FETCH ================= */
async function fetchVehicles(){
  status.textContent="Bet√∂lt√©s‚Ä¶";
  const r=await fetch("/vehicles",{cache:"no-store"});
  const data=await r.json();
  status.textContent=`J√°rm≈±vek: ${data.length}`;
  return data;
}

/* ================= MAIN ================= */
async function refreshData(){
  const vehicles=await fetchVehicles();

  fillSelect(routeFilter,unique(vehicles.map(v=>v.route_id)));
  fillSelect(typeFilter,unique(vehicles.map(v=>v.vehicle_model)));
  fillSelect(plateFilter,unique(vehicles.map(v=>v.license_plate)));

  const active=new Set();

  vehicles.forEach(v=>{
    if(v.latitude==null||v.longitude==null) return;
    if(routeFilter.value&&v.route_id!==routeFilter.value) return;
    if(typeFilter.value&&v.vehicle_model!==typeFilter.value) return;
    if(plateFilter.value&&v.license_plate!==plateFilter.value) return;
    if(decorFilter.checked&&!DECORATED.includes(v.license_plate)) return;

    const id=v.vehicle_id||`${v.route_id}_${v.latitude}_${v.longitude}`;
    active.add(id);

    if(markerMap.has(id)){
      markerMap.get(id).setLatLng([v.latitude,v.longitude]);
    } else {
      const marker=L.marker([v.latitude,v.longitude],{icon:iconFor(v)})
        .bindPopup(`
          <b>Viszonylat:</b> ${v.route_id}<br>
          <b>C√©l:</b> ${v.destination}<br>
          <b>Rendsz√°m:</b> ${v.license_plate}<br>
          <b>T√≠pus:</b> ${v.vehicle_model}
        `);

      markerMap.set(id,marker);
      cluster.addLayer(marker);
    }
  });

  for(const [id,marker] of markerMap){
    if(!active.has(id)){
      cluster.removeLayer(marker);
      markerMap.delete(id);
    }
  }
}

/* ================= EVENTS ================= */
refreshBtn.onclick=refreshData;
routeFilter.onchange=
typeFilter.onchange=
plateFilter.onchange=
decorFilter.onchange=refreshData;

/* auto refresh alapb√≥l KI */
setInterval(()=>{
  if(autoRefresh.checked) refreshData();
},5000);

/* indul√°s */
refreshData();
</script>
</body>
</html>
