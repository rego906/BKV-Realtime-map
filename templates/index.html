<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BKV realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2); font-family: Arial, sans-serif;
    }
    select, button, label { width: 220px; margin: 4px 0; }
    .small { font-size: 12px; color: #666; }
  </style>
</head>
<body>

<div id="controls">
  <div><b>Sz≈±r≈ëk</b></div>

  <label>Viszonylat:</label>
  <select id="routeFilter"></select>

  <label>T√≠pus:</label>
  <select id="typeFilter"></select>

  <label>Rendsz√°m:</label>
  <select id="plateFilter"></select>

  <button id="refreshBtn">Friss√≠t√©s</button>

  <label class="small"><input type="checkbox" id="autoRefresh" checked> Automatikus friss√≠t√©s (5 mp)</label>

  <!-- üéÑ D√≠sz√≠tett j√°rm≈±vek kapcsol√≥ -->
  <label class="small"><input type="checkbox" id="decorFilter"> üéÑ Csak feld√≠sz√≠tett j√°rm≈±vek</label>

  <div class="small" id="status"></div>
</div>


<div id="map"></div>

<script>
  const map = L.map('map').setView([47.4979, 19.0402], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

  let markers = [];

  /* --- Ikonok (l√©tezni√ºk kell az icons mapp√°ban) --- */
  const ICONS = {
    bus: "/icons/busz.png.png",
    tram: "/icons/villamos.png.png",
    trolley: "/icons/trolibusz.png.png",
    hev: "/icons/h√©v.png.png"
  };

  /* üéÑ D√≠sz√≠tett j√°rm≈±vek rendsz√°m alapj√°n */
  const DECORATED = ["V1347","V1608","V1441","V2038","V3873","V3888","V4012","V4120","V4064","JARMU1","BPI829","T9100"];


  /* -----------------------------  
      üî• J√°rm≈±kateg√≥ria felismer√©s  
      Csak a villamos kap villamos ikont  
  -----------------------------*/
  function detectMode(v) {
    const model = (v.vehicle_model || "").toLowerCase();
    const route = (v.route_id || "").toLowerCase();

    /* H√âV k√ºl√∂n */
    if (route.startsWith("h")) return "hev";

    /* Trolibusz */
    if (model.includes("trol") || model.includes("trollino")) return "trolley";

    /* üöã VILLAMOS ‚Äî MIND csak villamos ikont kap */
    if (
      model.includes("villamos") || model.includes("tram") ||
      model.includes("caf") || model.includes("combino") ||
      model.includes("tatra") || model.includes("t√°tra") ||
      model.includes("tw6000") ||
      model.includes("ganz") || model.includes("ipari") ||
      model.includes("csukl√≥s") || model.includes("kcsv7")
    ) return "tram";

    /* ‚ùó minden m√°s BUSZ */
    return "bus";
  }


  function makeIcon(url){ return L.icon({ iconUrl:url, iconSize:[32,32], iconAnchor:[16,16] }); }
  function iconFor(v){ return makeIcon(ICONS[detectMode(v)]); }


  async function fetchVehicles(){
    document.getElementById("status").textContent="Bet√∂lt√©s‚Ä¶";
    const data = await (await fetch("/vehicles",{cache:"no-store"})).json();
    document.getElementById("status").textContent=`J√°rm≈±vek: ${data.length}`;
    return data;
  }

  function uniqueSorted(arr){ return [...new Set(arr.filter(v=>v&&v!=="N/A"))].sort(); }


  /* -----------------------------
      üîÑ T√©rk√©p friss√≠t√©s
  -----------------------------*/
  async function refreshData(){
    const vehicles = await fetchVehicles();

    fillSelect(routeFilter, uniqueSorted(vehicles.map(v=>v.route_id)), true);
    fillSelect(typeFilter, uniqueSorted(vehicles.map(v=>v.vehicle_model)), true);
    fillSelect(plateFilter, uniqueSorted(vehicles.map(v=>v.license_plate)), true);

    markers.forEach(m=>map.removeLayer(m));
    markers = [];

    const r=routeFilter.value, t=typeFilter.value, p=plateFilter.value, d=decorFilter.checked;

    vehicles.forEach(v => {
      if(r && v.route_id!==r) return;
      if(t && v.vehicle_model!==t) return;
      if(p && v.license_plate!==p) return;

      /* üéÑ FONTOS: rendsz√°m alapj√°n sz≈±rj√ºk a f√©nyj√°rm≈±veket */
      if(d && !DECORATED.includes(v.license_plate)) return;

      const marker=L.marker([v.latitude,v.longitude],{icon:iconFor(v)}).bindPopup(`
        <b>Viszonylat:</b> ${v.route_id}<br>
        <b>C√©l:</b> ${v.destination}<br>
        <b>Rendsz√°m:</b> ${v.license_plate}<br>
        <b>T√≠pus:</b> ${v.vehicle_model}
      `);
      marker.addTo(map); markers.push(marker);
    });
  }

  function fillSelect(sel,arr,keep){
    const prev=sel.value; sel.innerHTML="<option value=''>√ñsszes</option>";
    arr.forEach(v=>sel.innerHTML+=`<option>${v}</option>`);
    if(keep && [...sel.options].some(o=>o.value===prev)) sel.value=prev;
  }

  refreshData();
  refreshBtn.onclick=refreshData;
  routeFilter.onchange=typeFilter.onchange=plateFilter.onchange=decorFilter.onchange=refreshData;
  setInterval(()=>{ if(autoRefresh.checked) refreshData(); },5000);
</script>

</body>
</html>
